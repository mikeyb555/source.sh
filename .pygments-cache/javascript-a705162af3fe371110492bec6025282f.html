<div class="highlight"><pre><span class="kd">var</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;aws-sdk&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">zlib</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">async</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;async&#39;</span><span class="p">)</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">region</span><span class="o">:</span> <span class="s1">&#39;us-east-1&#39;</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">bucket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">S3</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">logs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="nx">async</span><span class="p">.</span><span class="nx">eachSeries</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Records</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">iterator</span><span class="p">(</span><span class="nx">record</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">zlib</span><span class="p">.</span><span class="nx">gunzip</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">kinesis</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;base64&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">logEvents</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)).</span><span class="nx">logEvents</span>

            <span class="nx">logEvents</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">log</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">logs</span> <span class="o">=</span> <span class="nx">logs</span> <span class="o">+</span> <span class="nx">log</span><span class="p">.</span><span class="nx">message</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span>
                <span class="p">});</span>
            <span class="nx">callback</span><span class="p">();</span>
        <span class="p">});</span>

    <span class="p">},</span> <span class="kd">function</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
        <span class="nx">time_string</span> <span class="o">=</span> <span class="nx">now</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">+</span> 
	        <span class="s1">&#39;-&#39;</span> <span class="o">+</span> 
	        <span class="nx">now</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> 
	        <span class="nx">now</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> 
	        <span class="nx">now</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> 
	        <span class="nx">now</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> 
	        <span class="nx">now</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">();</span>

        <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">Bucket</span><span class="o">:</span> <span class="s1">&#39;&lt;yourbucketname&gt;&#39;</span><span class="p">,</span>
            <span class="nx">Key</span><span class="o">:</span> <span class="s1">&#39;cloudtrail_&#39;</span> <span class="o">+</span> <span class="nx">time_string</span><span class="p">,</span>
            <span class="nx">Body</span><span class="o">:</span> <span class="nx">logs</span>
        <span class="p">};</span>
        <span class="nx">bucket</span><span class="p">.</span><span class="nx">putObject</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
                <span class="nx">context</span><span class="p">.</span><span class="nx">fail</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="nx">context</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;complete&#39;</span><span class="p">);</span>
        <span class="p">});</span> 
    <span class="p">});</span>
<span class="p">};</span>
</pre></div>